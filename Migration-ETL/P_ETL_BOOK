CREATE OR REPLACE PROCEDURE P_ETL_BOOK AS
CURSOR EXT_CUR_BOOK IS 
SELECT EXTBOOK.*, 
MTBOOK.ID AS MTBOOKID 
FROM T_EXT_BOOK EXTBOOK 
LEFT JOIN T_MT_BOOK MTBOOK 
ON EXTBOOK.CODE = MTBOOK.CD;
EXT_ROW EXT_CUR_BOOK%ROWTYPE;

BEGIN

FOR EXT_ROW IN EXT_CUR_BOOK LOOP

	IF EXT_ROW.MTBOOKID IS NULL THEN
	INSERT INTO T_MT_BOOK 
	VALUES 
	(
		SYS_GUID(), 
		EXT_ROW.TITLE, 
		EXT_ROW.DESCRIPTION, 
		EXT_ROW.AUTHOR, 
		EXT_ROW.PUBLISHER,
		EXT_ROW.PRICE,
		EXT_ROW.STOCK,
		EXT_ROW.CODE
	);
	ELSE
	UPDATE T_MT_BOOK
	SET TITLE = EXT_ROW.TITLE,
		DESCRIPTION = EXT_ROW.DESCRIPTION,
		AUTHOR = EXT_ROW.AUTHOR,
		PUBLISHER = EXT_ROW.PUBLISHER,
		PRICE = EXT_ROW.PRICE,
		STOCK = EXT_ROW.STOCK
	WHERE CD = EXT_ROW.CODE;
	END IF;
END LOOP;
COMMIT;
END P_ETL_BOOK;
